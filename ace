#!/usr/bin/env php
<?php

require 'vendor/autoload.php';

$start_time = microtime(true);

$config = Symfony\Component\Yaml\Yaml::parse(file_get_contents('config.yml'));

if (null === $config) {
    exit('Config file does not exists');
}

foreach($config['ace']['command-chunks'] as $chunkName => $commandChunk) {
    $loop = React\EventLoop\Factory::create();
    echo PHP_EOL . 'Starting chunk ' . $chunkName . PHP_EOL;
    echo '----------------------------------------------' . PHP_EOL;

    foreach($commandChunk as $command) {
        $process = new React\ChildProcess\Process($command);
        $process->start($loop);

        echo "\tStarting " . $command . '...' . ' PID: ' . $process->getPid() . PHP_EOL;

        $process->on('exit', function() use($command) {
            echo "\t" . $command . ' finished!' . PHP_EOL;
        });
    }

    $loop->run();
}

$end_time = microtime(true);

echo 'Time spent: ' . round($end_time - $start_time, 2) . ' seconds' . PHP_EOL;
