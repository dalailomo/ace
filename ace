#!/usr/bin/env php
<?php

require 'vendor/autoload.php';

function notify($output, $command)
{
    echo <<<EOF

"$command":
---------------------------------------
$output

EOF;
}

$config = Symfony\Component\Yaml\Yaml::parse(file_get_contents('config.yml'));

if (null === $config) {
    exit('Config file does not exists');
}

$loop = React\EventLoop\Factory::create();

foreach($config['ace']['command-chunks'] as $chunkName => $commandChunk) {
    array_map(function ($command) use ($loop) {
        $process = new React\ChildProcess\Process($command);
        $process->start($loop);

        $process->stdout->on('data', function ($output) use ($command) {
            notify($output, $command);
        });

        $process->stderr->on('data', function ($output) use ($command) {
            notify("ERROR [" . $output . "]", $command);
        });
    }, $commandChunk);
}

$loop->run();
